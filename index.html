<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>äº‘ç«¯ç§é“¾Â·è·¨è®¾å¤‡ä¸ä¸¢è£…Â·å…¨åŠŸèƒ½ç‰ˆ</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui}
body{background:#0a0f1e;color:#e6e9f0;padding:15px}
.game{max-width:420px;margin:0 auto;background:#121a2f;border-radius:16px;overflow:hidden}
.head{background:#1b2542;padding:12px;text-align:center;font-weight:bold}
.panel{padding:15px}
.btn{width:100%;padding:12px;margin:6px 0;border:none;border-radius:10px;background:#2d4bff;color:#fff;font-weight:bold;cursor:pointer}
.btn-success{background:#00b850}
.btn-warning{background:#ff9500}
input{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:none;background:#1e273e;color:#fff}
.log{background:#0d1324;padding:12px;border-radius:8px;margin:10px 0;height:110px;overflow-y:auto;font-size:13px}
.bag{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:10px 0}
.item{background:#1b2542;padding:10px;border-radius:8px;text-align:center}
.hr{height:1px;background:#1e273e;margin:10px 0}
</style>
</head>
<body>
<div class="game">
  <div class="head">äº‘ç«¯ç§é“¾Â·å…¨åŠŸèƒ½Â·è·¨è®¾å¤‡åŒæ­¥</div>
  <div class="panel">
    <button class="btn" onclick="createWallet()">ğŸª™ åˆ›å»ºé’±åŒ…</button>
    <button class="btn" onclick="showMnemonic()">ğŸ“„ æŸ¥çœ‹åŠ©è®°è¯</button>
    <input id="mneInput" placeholder="12å•è¯åŠ©è®°è¯æ¢å¤è´¦å·">
    <button class="btn" onclick="restoreAccount()">âœ… æ¢å¤è´¦å·</button>
    <div class="hr"></div>
    <button class="btn btn-success" onclick="fight()">âš”ï¸ æ‰“æ€ªçˆ†è£…å¤‡</button>
    <div class="hr"></div>
    <input id="toAddr" placeholder="å¯¹æ–¹åœ°å€">
    <input id="itemName" placeholder="é“å…·å">
    <button class="btn btn-warning" onclick="sendItem()">ğŸ“¤ å‘é€é“å…·</button>
    <div class="hr"></div>
    <div>ğŸ’ æˆ‘çš„èƒŒåŒ…</div>
    <div class="bag" id="bag"></div>
    <div>æ—¥å¿—</div>
    <div class="log" id="log"></div>
  </div>
</div>

<script>
const logBox = document.getElementById('log');
const bagBox = document.getElementById('bag');
const KEY_MNE = 'game_mne';
const KEY_ADDR = 'game_addr';

// ğŸ‘‰ éƒ¨ç½²åæ”¹æˆä½ çš„ Vercel åŸŸå
const API = "https://game-link-8n5w.vercel.app";

const words = "apple banana cherry date elder fig grape honey ice juice kite lemon mango nut orange pear queen rose sun tomato umbrella van water xmas yellow zebra".split(' ');

function print(text) {
  logBox.innerText = `[${new Date().toLocaleTimeString()}] ${text}\n` + logBox.innerText;
}

// ====================== é’±åŒ… & åŠ©è®°è¯æ¢å¤ï¼ˆå®Œå…¨ä¿ç•™ï¼‰ ======================
function createWallet() {
  const mne = Array(12).fill(0).map(()=>words[Math.random()*words.length|0]).join(' ');
  const addr = mne.replace(/\s/g,'').slice(-16);
  localStorage.setItem(KEY_MNE, mne);
  localStorage.setItem(KEY_ADDR, addr);
  print('âœ… é’±åŒ…å·²åˆ›å»º');
  print('ğŸ“ åœ°å€ï¼š'+addr);
  refreshBag();
}

function showMnemonic() {
  const mne = localStorage.getItem(KEY_MNE);
  mne ? print('ğŸ“‹ åŠ©è®°è¯ï¼š'+mne) : print('âŒ æœªåˆ›å»ºé’±åŒ…');
}

function restoreAccount() {
  const input = document.getElementById('mneInput').value.trim();
  if(input.split(/\s+/).length!==12) return print('âŒ è¯·è¾“å…¥12ä¸ªå•è¯');
  const addr = input.replace(/\s/g,'').slice(-16);
  localStorage.setItem(KEY_MNE, input);
  localStorage.setItem(KEY_ADDR, addr);
  print('âœ… è´¦å·æ¢å¤æˆåŠŸï¼');
  print('ğŸ“ åœ°å€ï¼š'+addr);
  refreshBag();
}

function getMe() {
  return localStorage.getItem(KEY_ADDR);
}

// ====================== äº‘ç«¯ç§é“¾è¯»å†™ ======================
async function getState() {
  const res = await fetch(API+"/get-chain");
  return await res.json();
}

async function saveState(state) {
  await fetch(API+"/update-chain", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({state})
  });
}

// ====================== èƒŒåŒ… ======================
async function refreshBag() {
  const me = getMe();
  if(!me) return;
  const state = await getState();
  const myItems = state[me] || [];
  bagBox.innerHTML = '';
  if(myItems.length===0){
    const d = document.createElement('div');
    d.className='item'; d.innerText='ç©ºç©ºå¦‚ä¹Ÿ';
    bagBox.appendChild(d);
    return;
  }
  myItems.forEach(name => {
    const d = document.createElement('div');
    d.className='item'; d.innerText=name;
    bagBox.appendChild(d);
  });
}

// ====================== æ‰“æ€ª ======================
async function fight() {
  const me = getMe();
  if(!me) return print('âŒ å…ˆåˆ›å»ºé’±åŒ…');
  const state = await getState();
  const items = ['é“å‰‘','å¸ƒè¡£','æˆ’æŒ‡','é´å­','è¯æ°´'];
  const name = items[Math.random()*5|0];
  state[me] = state[me] || [];
  state[me].push(name);
  await saveState(state);
  print('ğŸ è·å¾—ï¼š'+name);
  refreshBag();
}

// ====================== å‘é€é“å…· ======================
async function sendItem() {
  const me = getMe();
  const to = document.getElementById('toAddr').value.trim();
  const name = document.getElementById('itemName').value.trim();
  if(!me || !to || !name) return print('âŒ ä¿¡æ¯ä¸å…¨');

  const state = await getState();
  if(!state[me]?.includes(name)) return print('âŒ ä½ æ²¡æœ‰è¯¥é“å…·');

  state[me].splice(state[me].indexOf(name), 1);
  state[to] = state[to] || [];
  state[to].push(name);
  await saveState(state);
  print('âœ… å‘é€æˆåŠŸï¼š'+name);
  refreshBag();
}

// åˆå§‹åŒ–
refreshBag();
</script>
</body>
</html>
