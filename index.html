<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„é“¾æ¸¸ - IPFS å…¬å…±é“¾</title>
    <style>
        * {box-sizing:border-box;margin:0;padding:0;font-family:system-ui}
        body {background:#0b0f1a;color:#fff;padding:20px}
        .container {max-width:600px;margin:0 auto}
        .log {background:#121a29;padding:12px;border-radius:8px;margin:10px 0;min-height:120px;font-size:13px;white-space:pre-wrap}
        .btn {padding:8px 12px;margin:4px;border:none;border-radius:6px;background:#4a7dff;color:#fff;cursor:pointer}
        .btn-success {background:#00C851}
        .btn-warning {background:#ff8800}
        input {width:100%;padding:10px;margin:8px 0;border-radius:6px;border:none;background:#1e2530;color:#fff}
    </style>
</head>
<body>
<div class="container">
    <h1>é“¾æ¸¸ - IPFS å…¬å…±é“¾</h1>
    <p>çŠ¶æ€ï¼šç¬¬å…­æ­¥Â·å…¨ç½‘èµ„äº§åŒæ­¥</p>

    <button class="btn" onclick="createWallet()">ç”Ÿæˆé’±åŒ…</button>
    <button class="btn" onclick="showMyMnemonic()">æŸ¥çœ‹åŠ©è®°è¯</button>
    <button class="btn-success" onclick="mintItem()">ç”Ÿæˆæ–°æ‰‹å‰‘</button>
    <button class="btn" onclick="showMyItems()">æŸ¥çœ‹æˆ‘çš„é“å…·</button>
    
    <button class="btn btn-warning" onclick="uploadChainToIPFS()">ä¸Šä¼ é“¾åˆ° IPFS</button>
    
    <input id="inputCID" placeholder="è¾“å…¥IPFS CID æ‹‰å–å…¨é“¾">
    <button class="btn" onclick="pullChainFromIPFS()">æ‹‰å– IPFS é“¾</button>

    <input id="inputMnemonic" placeholder="ç²˜è´´åŠ©è®°è¯æ¢å¤è´¦å·">
    <button class="btn" onclick="restoreWalletAndAssets()">æ¢å¤è´¦å·&èµ„äº§</button>

    <h3>è°ƒè¯•æ—¥å¿—</h3>
    <div id="log" class="log">ç­‰å¾…æ“ä½œ...</div>
</div>

<script>
const logDom = document.getElementById('log');
const STORAGE_MNEMONIC = 'game_mnemonic';
const STORAGE_CHAIN = 'game_chain';
const words = "apple banana cherry date elder fig grape honey ice juice kite lemon mango nut orange pear queen rose sun tomato umbrella van water xmas yellow zebra".split(" ");

function log(text) {
    logDom.innerText = `[${new Date().toLocaleString()}] ${text}\n` + logDom.innerText;
}

// ====================== é’±åŒ… ======================
function createWallet() {
    const mnemonic = Array(12).fill(0).map(()=>words[Math.random()*words.length|0]).join(" ");
    localStorage.setItem(STORAGE_MNEMONIC, mnemonic);
    log("âœ… é’±åŒ…å·²ç”Ÿæˆ");
}
function showMyMnemonic() {
    const mne = localStorage.getItem(STORAGE_MNEMONIC);
    mne ? log("ğŸ“„ åŠ©è®°è¯ï¼š"+mne) : log("âš ï¸ æœªåˆ›å»ºé’±åŒ…");
}

// ====================== SHA256 å“ˆå¸Œ ======================
async function sha256(s) {
    const enc = new TextEncoder();
    const d = await crypto.subtle.digest('SHA-256', enc.encode(s));
    return Array.from(new Uint8Array(d)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// ====================== æœ¬åœ°å“ˆå¸Œé“¾ ======================
function initChain() { if(!localStorage.getItem(STORAGE_CHAIN)) localStorage.setItem(STORAGE_CHAIN,'[]') }
function getChain() { return JSON.parse(localStorage.getItem(STORAGE_CHAIN)||'[]') }
function saveChain(c) { localStorage.setItem(STORAGE_CHAIN, JSON.stringify(c)) }

async function addRecord(data) {
    const chain = getChain();
    const prev = chain.length ? chain[chain.length-1].hash : 'genesis';
    const block = {index:chain.length, time:Date.now(), prevHash:prev, data, hash:''};
    block.hash = await sha256(JSON.stringify(block));
    chain.push(block);
    saveChain(chain);
    return block;
}

// ====================== é“å…·ç³»ç»Ÿ ======================
async function mintItem() {
    const mne = localStorage.getItem(STORAGE_MNEMONIC);
    if(!mne) return log("âš ï¸ å…ˆåˆ›å»ºé’±åŒ…");
    const b = await addRecord({type:"item", owner:mne, itemName:"æ–°æ‰‹å‰‘", id:Date.now()});
    log(`âœ… è·å¾—ã€æ–°æ‰‹å‰‘ã€‘ è®°å½•#${b.index}`);
}

function showMyItems() {
    const mne = localStorage.getItem(STORAGE_MNEMONIC);
    if(!mne) return log("âš ï¸ å…ˆåˆ›å»ºé’±åŒ…");
    const items = getChain().filter(i=>i.data.type==="item" && i.data.owner===mne);
    items.length ? log(`ğŸ’ å…±æ‹¥æœ‰ ${items.length} ä¸ªé“å…·`) : log("ğŸ’ èƒŒåŒ…ç©º");
}

// ====================== è´¦å·æ¢å¤ ======================
function restoreWalletAndAssets() {
    const val = document.getElementById('inputMnemonic').value.trim();
    if(val.split(/\s+/).length!==12) return log("âŒ è¯·è¾“å…¥12ä¸ªå•è¯åŠ©è®°è¯");
    localStorage.setItem(STORAGE_MNEMONIC, val);
    log("âœ… è´¦å·æ¢å¤æˆåŠŸ");
    showMyItems();
}

// ====================== IPFS ä¸Šä¼ /æ‹‰å–ï¼ˆæ ¸å¿ƒï¼‰ ======================
// ä¸Šä¼ é“¾åˆ° IPFS
async function uploadChainToIPFS() {
    const chain = getChain();
    if(chain.length === 0) return log("âš ï¸ é“¾ä¸ºç©º");

    try {
        const formData = new FormData();
        formData.append('file', new Blob([JSON.stringify(chain)], {type:'application/json'}));

        const res = await fetch('https://ipfs.io/api/v0/add?pin=true', {
            method: 'POST',
            body: formData
        });
        const json = await res.json();
        const cid = json.Hash;
        log("ğŸ“¡ ä¸Šä¼ æˆåŠŸï¼IPFS CIDï¼š"+cid);
        document.getElementById('inputCID').value = cid;
    } catch(e) {
        log("âŒ ä¸Šä¼ å¤±è´¥ï¼šç½‘ç»œæˆ–IPFSé™åˆ¶");
    }
}

// ä» IPFS æ‹‰å–å…¨é“¾
async function pullChainFromIPFS() {
    const cid = document.getElementById('inputCID').value.trim();
    if(!cid) return log("âš ï¸ è¯·è¾“å…¥CID");

    try {
        const res = await fetch(`https://ipfs.io/ipfs/${cid}`);
        const chain = await res.json();
        saveChain(chain);
        log("ğŸ“¥ æ‹‰å–æˆåŠŸï¼å·²åŒæ­¥å…¨é“¾æ•°æ®");
        showMyItems();
    } catch(e) {
        log("âŒ æ‹‰å–å¤±è´¥ï¼šCIDæ— æ•ˆæˆ–ç½‘ç»œå¼‚å¸¸");
    }
}

// ====================== åˆå§‹åŒ– ======================
window.onload = initChain;
</script>
</body>
</html>
