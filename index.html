<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„é“¾æ¸¸ - å“ˆå¸Œé“¾</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: system-ui, sans-serif;
        }
        body {
            background: #0b0f1a;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .log {
            background: #121a29;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            min-height: 120px;
            font-size: 13px;
            white-space: pre-wrap;
        }
        .btn {
            padding: 8px 12px;
            margin:4px;
            border:none;
            border-radius:6px;
            background:#4a7dff;
            color:#fff;
            cursor:pointer;
        }
        .btn-danger {
            background: #ff4444;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>é“¾æ¸¸ - å“ˆå¸Œé“¾è´¦æœ¬</h1>
    <p>çŠ¶æ€ï¼šç¬¬ä¸‰æ­¥Â·ä¸å¯ç¯¡æ”¹è®°å½•</p>

    <div>
        <button class="btn" onclick="createWallet()">ç”Ÿæˆé’±åŒ…</button>
        <button class="btn" onclick="showMyMnemonic()">æŸ¥çœ‹åŠ©è®°è¯</button>
        <button class="btn" onclick="addTestRecord()">æ–°å¢ä¸€æ¡è®°å½•</button>
        <button class="btn" onclick="showChain()">æŸ¥çœ‹å“ˆå¸Œé“¾</button>
        <button class="btn" onclick="verifyChain()">æ ¡éªŒæ˜¯å¦ç¯¡æ”¹</button>
        <button class="btn btn-danger" onclick="fakeTamperTest()">æ¨¡æ‹Ÿç¯¡æ”¹æµ‹è¯•</button>
    </div>

    <h3>è°ƒè¯•æ—¥å¿—</h3>
    <div id="log" class="log">ç­‰å¾…æ“ä½œ...</div>
</div>

<script>
const logDom = document.getElementById('log');
const STORAGE_MNEMONIC = 'game_mnemonic';
const STORAGE_CHAIN = 'game_chain';

// åŠ©è®°è¯è¯åº“
const words = "apple banana cherry date elder fig grape honey ice juice kite lemon mango nut orange pear queen rose sun tomato umbrella van water xmas yellow zebra".split(" ");

// æ—¥å¿—è¾“å‡º
function log(text) {
    logDom.innerText = `[${new Date().toLocaleString()}] ${text}\n` + logDom.innerText;
}

// ====================== é’±åŒ…åŠŸèƒ½ ======================
function generateMnemonic() {
    let res = [];
    for(let i=0; i<12; i++) {
        let r = Math.floor(Math.random() * words.length);
        res.push(words[r]);
    }
    return res.join(" ");
}
function createWallet() {
    try {
        const mnemonic = generateMnemonic();
        localStorage.setItem(STORAGE_MNEMONIC, mnemonic);
        log("âœ… é’±åŒ…å·²ç”Ÿæˆ");
    } catch (e) { log("âŒ ç”Ÿæˆå¤±è´¥ï¼š"+e.message); }
}
function showMyMnemonic() {
    const mne = localStorage.getItem(STORAGE_MNEMONIC);
    mne ? log("ğŸ“„ åŠ©è®°è¯ï¼š"+mne) : log("âš ï¸ æœªåˆ›å»ºé’±åŒ…");
}

// ====================== åŸç”ŸSHA-256å“ˆå¸Œ ======================
async function sha256(str) {
    const encoder = new TextEncoder();
    const data = encoder.encode(str);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
}

// ====================== å“ˆå¸Œé“¾æ ¸å¿ƒ ======================
// åˆå§‹åŒ–é“¾
function initChain() {
    if(!localStorage.getItem(STORAGE_CHAIN)) {
        localStorage.setItem(STORAGE_CHAIN, JSON.stringify([]));
    }
}

// è·å–æ•´æ¡é“¾
function getChain() {
    return JSON.parse(localStorage.getItem(STORAGE_CHAIN) || '[]');
}

// ä¿å­˜é“¾
function saveChain(chain) {
    localStorage.setItem(STORAGE_CHAIN, JSON.stringify(chain));
}

// æ–°å¢è®°å½•
async function addRecord(data) {
    const chain = getChain();
    const prevHash = chain.length > 0 ? chain[chain.length-1].hash : 'genesis';

    const block = {
        index: chain.length,
        time: Date.now(),
        prevHash: prevHash,
        data: data,
        hash: ''
    };

    // è®¡ç®—æœ¬å—å“ˆå¸Œ
    block.hash = await sha256(JSON.stringify(block));
    chain.push(block);
    saveChain(chain);
    return block;
}

// æ ¡éªŒæ•´æ¡é“¾æ˜¯å¦è¢«ç¯¡æ”¹
async function verifyChain() {
    const chain = getChain();
    if(chain.length === 0) return true;

    for(let i=1; i<chain.length; i++) {
        const cur = chain[i];
        const prev = chain[i-1];

        // é‡æ–°è®¡ç®—å“ˆå¸Œ
        const temp = {...cur, hash: ''};
        const reHash = await sha256(JSON.stringify(temp));

        if(cur.hash !== reHash || cur.prevHash !== prev.hash) {
            log(`âŒ ç¬¬${i}å—è¢«ç¯¡æ”¹ï¼`);
            return false;
        }
    }
    log("âœ… å“ˆå¸Œé“¾å®Œæ•´ï¼Œæœªè¢«ç¯¡æ”¹");
    return true;
}

// ====================== æµ‹è¯•å‡½æ•° ======================
async function addTestRecord() {
    const user = localStorage.getItem(STORAGE_MNEMONIC)?.substring(0,10) || 'guest';
    const block = await addRecord({
        user: user,
        action: 'test_record',
        note: 'æµ‹è¯•ä¸å¯ç¯¡æ”¹è®°å½•'
    });
    log(`âœ… æ–°å¢è®°å½• #${block.index}ï¼Œå“ˆå¸Œå‰16ä½ï¼š${block.hash.substring(0,16)}...`);
}

function showChain() {
    const chain = getChain();
    if(chain.length === 0) {
        log("â„¹ï¸ æš‚æ— è®°å½•");
        return;
    }
    const last = chain[chain.length-1];
    log(`ğŸ“¦ å…±${chain.length}æ¡è®°å½•ï¼Œæœ€æ–° #${last.index} å“ˆå¸Œï¼š${last.hash.substring(0,16)}...`);
}

// æ¨¡æ‹Ÿç¯¡æ”¹ï¼ˆæ•…æ„ç ´åæ•°æ®ï¼‰
function fakeTamperTest() {
    const chain = getChain();
    if(chain.length < 2) {
        log("âš ï¸ è‡³å°‘2æ¡è®°å½•æ‰èƒ½æµ‹è¯•ç¯¡æ”¹");
        return;
    }
    chain[1].data.note = "æˆ‘è¢«ç¯¡æ”¹äº†ï¼";
    saveChain(chain);
    log("âš ï¸ å·²æ¨¡æ‹Ÿä¿®æ”¹ç¬¬1å—æ•°æ®ï¼Œè¯·ç‚¹ã€æ ¡éªŒæ˜¯å¦ç¯¡æ”¹ã€‘");
}

// åˆå§‹åŒ–
window.onload = () => {
    initChain();
    log("æ¸¸æˆåŸºåº§+å“ˆå¸Œé“¾åŠ è½½å®Œæˆ âœ…");
};
</script>
</body>
</html>
