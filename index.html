<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é›¶æœåŠ¡å™¨ç§é“¾Â·äº¤æ˜“+è´¦å·æ¢å¤ç‰ˆ</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui}
body{background:#0a0f1e;color:#e6e9f0;padding:15px}
.game{max-width:420px;margin:0 auto;background:#121a2f;border-radius:16px;overflow:hidden}
.head{background:#1b2542;padding:12px;text-align:center;font-weight:bold}
.panel{padding:15px}
.btn{width:100%;padding:12px;margin:6px 0;border:none;border-radius:10px;background:#2d4bff;color:#fff;font-weight:bold;cursor:pointer}
.btn-success{background:#00b850}
.btn-warning{background:#ff9500}
.btn-danger{background:#ff4444}
input{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:none;background:#1e273e;color:#fff}
.log{background:#0d1324;padding:12px;border-radius:8px;margin:10px 0;height:110px;overflow-y:auto;font-size:13px}
.bag{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:10px 0}
.item{background:#1b2542;padding:10px;border-radius:8px;text-align:center;font-size:12px}
.hr{height:1px;background:#1e273e;margin:10px 0}
</style>
</head>
<body>
<div class="game">
  <div class="head">é›¶æœåŠ¡å™¨ç§é“¾Â·äº¤æ˜“+è´¦å·æ¢å¤</div>
  <div class="panel">
    <button class="btn" onclick="createWallet()">ğŸª™ åˆ›å»ºé’±åŒ…</button>
    <button class="btn" onclick="showMnemonic()">ğŸ“„ æŸ¥çœ‹åŠ©è®°è¯</button>
    <button class="btn" onclick="refreshChain()">ğŸ”„ åˆ·æ–°å…¨æœé“¾</button>
    
    <input id="restoreMne" placeholder="è¾“å…¥12ä¸ªå•è¯åŠ©è®°è¯æ¢å¤è´¦å·">
    <button class="btn-danger" onclick="restoreAccount()">âœ… æ¢å¤è´¦å·</button>
    <div class="hr"></div>
    
    <button class="btn-success" onclick="fight()">âš”ï¸ æ‰“æ€ªçˆ†è£…å¤‡</button>
    <div class="hr"></div>

    <input id="toAddr" placeholder="å¯¹æ–¹é’±åŒ…åœ°å€">
    <input id="sendItemName" placeholder="è¦å‘é€çš„é“å…·å">
    <button class="btn-warning" onclick="sendItem()">ğŸ“¤ å‘é€é“å…·ç»™å¯¹æ–¹</button>
    
    <div class="hr"></div>
    <div>èƒŒåŒ…</div>
    <div class="bag" id="bag"></div>
    <div>æ—¥å¿—</div>
    <div class="log" id="log"></div>
  </div>
</div>

<script>
const logBox = document.getElementById('log')
const bagBox = document.getElementById('bag')
const KEY_MNEMONIC = 'game_mnemonic'
const KEY_ADDR = 'game_addr'

// éƒ¨ç½²åæ”¹æˆä½ è‡ªå·± Vercel çš„ chain.json
const CHAIN_URL = 'https://your-domain.vercel.app/chain.json?t=' + Date.now()

// åŠ©è®°è¯åº“
const words = "apple banana cherry date elder fig grape honey ice juice kite lemon mango nut orange pear queen rose sun tomato umbrella van water xmas yellow zebra".split(" ")

function print(text) {
  logBox.innerText = `[${new Date().toLocaleTimeString()}] ${text}\n` + logBox.innerText
}

// ====================== é’±åŒ… + è´¦å·æ¢å¤ï¼ˆæ ¸å¿ƒï¼‰ ======================
// åˆ›å»ºé’±åŒ…ï¼šåŠ©è®°è¯ + åœ°å€
function createWallet() {
  // ç”Ÿæˆ12ä¸ªå•è¯åŠ©è®°è¯
  const mne = Array(12).fill(0).map(()=>words[Math.random()*words.length|0]).join(" ")
  // ç”¨åŠ©è®°è¯å“ˆå¸Œç”Ÿæˆå”¯ä¸€åœ°å€
  sha256(mne).then(hash=>{
    const addr = hash.slice(0,16) // å–å‰16ä½å½“åœ°å€
    localStorage.setItem(KEY_MNEMONIC, mne)
    localStorage.setItem(KEY_ADDR, addr)
    print("âœ… é’±åŒ…åˆ›å»ºæˆåŠŸ")
    print("ğŸ“Œ ä½ çš„åœ°å€ï¼š"+addr)
    refreshChain()
  })
}

// æŸ¥çœ‹åŠ©è®°è¯
function showMnemonic() {
  const mne = localStorage.getItem(KEY_MNEMONIC)
  mne ? print("ğŸ“‹ åŠ©è®°è¯ï¼š"+mne) : print("âš ï¸ æœªåˆ›å»ºé’±åŒ…")
}

// æ¢å¤è´¦å·ï¼šåŠ©è®°è¯ â†’ è¿˜åŸåœ°å€
async function restoreAccount() {
  const inputMne = document.getElementById("restoreMne").value.trim()
  if(inputMne.split(/\s+/).length !== 12) {
    return print("âŒ è¯·è¾“å…¥12ä¸ªå•è¯åŠ©è®°è¯")
  }
  const hash = await sha256(inputMne)
  const addr = hash.slice(0,16)
  localStorage.setItem(KEY_MNEMONIC, inputMne)
  localStorage.setItem(KEY_ADDR, addr)
  print("âœ… è´¦å·æ¢å¤æˆåŠŸï¼")
  print("ğŸ“Œ æ¢å¤åœ°å€ï¼š"+addr)
  refreshChain()
}

// è·å–å½“å‰åœ°å€
function getMyAddr() {
  return localStorage.getItem(KEY_ADDR)
}

// ====================== SHA256 é˜²ç¯¡æ”¹ ======================
async function sha256(str) {
  const msg = new TextEncoder().encode(str)
  const hash = await crypto.subtle.digest('SHA-256', msg)
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('')
}

// æ ¡éªŒæ•´æ¡é“¾
async function verifyChain(chain) {
  if (!chain || chain.length === 0) return true
  for (let i = 1; i < chain.length; i++) {
    const cur = chain[i]
    const pre = chain[i - 1]
    const temp = { ...cur, hash: '' }
    const calcHash = await sha256(JSON.stringify(temp))
    if (cur.hash !== calcHash || cur.prevHash !== pre.hash) return false
  }
  return true
}

// æ‹‰å–å…¨æœé“¾
async function refreshChain() {
  try {
    const res = await fetch(CHAIN_URL)
    const chain = await res.json()
    const ok = await verifyChain(chain)
    if (!ok) {
      print('âŒ é“¾è¢«ç¯¡æ”¹ï¼å…¨æœæ‹’ç»æ•°æ®')
      return null
    }
    window.GLOBAL_CHAIN = chain
    print('âœ… å…¨æœé“¾åŒæ­¥å®Œæˆ')
    showBag()
    return chain
  } catch (e) {
    print('âš ï¸ ä½¿ç”¨æœ¬åœ°æ¼”ç¤ºé“¾')
    if (!window.GLOBAL_CHAIN) {
      const genesis = {
        index: 0, time: Date.now(), prevHash: '0',
        data: { type: 'genesis' }, hash: await sha256('genesis')
      }
      window.GLOBAL_CHAIN = [genesis]
    }
    return window.GLOBAL_CHAIN
  }
}

// åˆæ³•ä¸Šé“¾
async function addBlock(data) {
  const chain = await refreshChain()
  if (!chain) return null
  const valid = await verifyChain(chain)
  if (!valid) {
    print('âŒ ä½œå¼Šï¼šé“¾å·²è¢«ç¯¡æ”¹')
    return null
  }
  const last = chain[chain.length - 1]
  const block = {
    index: chain.length,
    time: Date.now(),
    prevHash: last.hash,
    data,
    hash: ''
  }
  block.hash = await sha256(JSON.stringify({ ...block, hash: '' }))
  chain.push(block)
  window.GLOBAL_CHAIN = chain
  return block
}

// æ‰“æ€ª
async function fight() {
  const me = getMyAddr()
  if (!me) return print('âš ï¸ å…ˆåˆ›å»ºé’±åŒ…')
  const items = ['é“å‰‘', 'å¸ƒè¡£', 'æˆ’æŒ‡', 'é´å­', 'è¯æ°´']
  const item = items[Math.random() * 5 | 0]
  await addBlock({ type: 'item', owner: me, name: item })
  print(`ğŸ è·å¾—ï¼š${item}`)
}

// èƒŒåŒ…
function showBag() {
  const me = getMyAddr()
  if (!me || !window.GLOBAL_CHAIN) return
  const items = window.GLOBAL_CHAIN.filter(b =>
    b.data.type === 'item' && b.data.owner === me
  )
  bagBox.innerHTML = ''
  items.forEach(it => {
    const d = document.createElement('div')
    d.className = 'item'
    d.innerText = it.data.name
    bagBox.appendChild(d)
  })
}

// ====================== é“å…·äº¤æ˜“ ======================
async function sendItem() {
  const me = getMyAddr()
  const to = document.getElementById('toAddr').value.trim()
  const name = document.getElementById('sendItemName').value.trim()
  if (!me || !to || !name) return print('âš ï¸ ä¿¡æ¯ä¸å…¨')
  if (me === to) return print('âš ï¸ ä¸èƒ½å‘ç»™è‡ªå·±')

  const chain = window.GLOBAL_CHAIN
  const has = chain.some(b =>
    b.data.type === 'item' && b.data.owner === me && b.data.name === name
  )
  if (!has) return print('âŒ ä½ æ²¡æœ‰è¿™ä¸ªé“å…·')

  await addBlock({ type: 'trade_remove', from: me, item: name })
  await addBlock({ type: 'trade_add', to: to, item: name })

  print(`âœ… å‘é€ã€${name}ã€‘æˆåŠŸ`)
  refreshChain()
}

// åˆå§‹åŒ–
window.onload = () => {
  if (getMyAddr()) refreshChain()
}
</script>
</body>
</html>
