<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è·¨æµè§ˆå™¨æ°¸ä¸ä¸¢è£…å¤‡Â·ç¨³å®šç‰ˆ</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui}
body{background:#0a0f1e;color:#e6e9f0;padding:15px}
.game{max-width:420px;margin:0 auto;background:#121a2f;border-radius:16px;overflow:hidden}
.head{background:#1b2542;padding:12px;text-align:center;font-weight:bold}
.panel{padding:15px}
.btn{width:100%;padding:12px;margin:6px 0;border:none;border-radius:10px;background:#2d4bff;color:#fff;font-weight:bold}
input{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:none;background:#1e273e;color:#fff}
.log{background:#0d1324;padding:12px;border-radius:8px;margin:10px 0;height:110px;overflow-y:auto;font-size:13px}
.bag{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:10px 0}
.item{background:#1b2542;padding:10px;border-radius:8px;text-align:center}
.hr{height:1px;background:#1e273e;margin:10px 0}
</style>
</head>
<body>
<div class="game">
  <div class="head">å…¨æœç»Ÿä¸€ç§é“¾Â·ç¨³å®šç‰ˆ</div>
  <div class="panel">
    <button class="btn" onclick="createWallet()">ğŸª™ åˆ›å»ºé’±åŒ…</button>
    <button class="btn" onclick="showMnemonic()">ğŸ“„ åŠ©è®°è¯</button>
    <input id="mneInput" placeholder="12ä¸ªå•è¯æ¢å¤è´¦å·">
    <button class="btn" onclick="restoreAccount()">âœ… æ¢å¤è´¦å·</button>
    <div class="hr"></div>
    <button class="btn" onclick="fight()">âš”ï¸ æ‰“æ€ª</button>
    <button class="btn" onclick="refreshBag()">ğŸ”„ åˆ·æ–°èƒŒåŒ…</button>
    <div class="hr"></div>
    <input id="toAddr" placeholder="å¯¹æ–¹åœ°å€">
    <input id="itemName" placeholder="é“å…·å">
    <button class="btn" onclick="sendItem()">ğŸ“¤ å‘é€é“å…·</button>
    <div class="hr"></div>
    <div>ğŸ’ æˆ‘çš„èƒŒåŒ…</div>
    <div class="bag" id="bag"></div>
    <div>æ—¥å¿—</div>
    <div class="log" id="log"></div>
  </div>
</div>

<script>
const logBox = document.getElementById('log');
const bagBox = document.getElementById('bag');
const KEY_MNE = 'game_mne';
const KEY_ADDR = 'game_addr';

// ğŸ‘‰ æ”¹æˆä½ çš„ Vercel åŸŸå
const CHAIN_URL = 'https://game-link-8n5w.vercel.app/chain.json';

const words = "apple banana cherry date elder fig grape honey ice juice kite lemon mango nut orange pear queen rose sun tomato umbrella van water xmas yellow zebra".split(' ');

function print(text) {
  logBox.innerText = `[${new Date().toLocaleTimeString()}] ${text}\n` + logBox.innerText;
}

// ============== 1. è´¦å·ç³»ç»Ÿï¼ˆå®Œå…¨ä¿ç•™ï¼‰ ==============
function createWallet() {
  const mne = Array(12).fill(0).map(()=>words[Math.random()*words.length|0]).join(' ');
  const addr = mne.replace(/\s/g, '').slice(-16);
  localStorage.setItem(KEY_MNE, mne);
  localStorage.setItem(KEY_ADDR, addr);
  print('âœ… é’±åŒ…å·²åˆ›å»º');
  print('ğŸ“ åœ°å€:'+addr);
  refreshBag();
}

function showMnemonic() {
  const mne = localStorage.getItem(KEY_MNE);
  mne ? print('ğŸ“‹ åŠ©è®°è¯ï¼š'+mne) : print('âŒ æœªåˆ›å»ºé’±åŒ…');
}

function restoreAccount() {
  const input = document.getElementById('mneInput').value.trim();
  if(input.split(/\s+/).length!==12) return print('âŒ éœ€12ä¸ªå•è¯');
  const addr = input.replace(/\s/g, '').slice(-16);
  localStorage.setItem(KEY_MNE, input);
  localStorage.setItem(KEY_ADDR, addr);
  print('âœ… è´¦å·æ¢å¤æˆåŠŸï¼');
  print('ğŸ“ åœ°å€:'+addr);
  refreshBag();
}

function getMe() {
  return localStorage.getItem(KEY_ADDR);
}

// ============== 2. æ ¸å¿ƒä¿®å¤ï¼šé“¾æ•°æ®è¯»å†™å®Œæ•´å®ç° ==============
// è¯»å–å…¨æœæ•°æ®
async function readChain() {
  try {
    const res = await fetch(CHAIN_URL + '?t=' + Date.now());
    return await res.json();
  } catch (e) {
    print('âš ï¸ é¦–æ¬¡åŠ è½½ï¼Œåˆ›å»ºæ–°é“¾');
    return {};
  }
}

// å†™å…¥å…¨æœæ•°æ®ï¼ˆå…³é”®ä¿®å¤ï¼‰
async function writeChain(newState) {
  try {
    const res = await fetch(CHAIN_URL, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(newState, null, 2),
    });
    if (res.ok) {
      print('ğŸ“ é“¾æ•°æ®å·²ä¿å­˜');
      return true;
    }
    print('âŒ ä¿å­˜å¤±è´¥ï¼ŒçŠ¶æ€ç : '+res.status);
    return false;
  } catch (e) {
    print('âŒ ä¿å­˜å‡ºé”™: '+e.message);
    return false;
  }
}

// ============== 3. èƒŒåŒ…æ˜¾ç¤ºï¼ˆä¿®å¤ä¸æ˜¾ç¤ºé—®é¢˜ï¼‰ ==============
async function refreshBag() {
  const me = getMe();
  if(!me) return print('âŒ å…ˆåˆ›å»º/æ¢å¤è´¦å·');
  
  const state = await readChain();
  const myItems = state[me] || [];
  
  // å¼ºåˆ¶æ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“ï¼ˆè§£å†³ä¸æ˜¾ç¤ºé—®é¢˜ï¼‰
  bagBox.innerHTML = '';
  if (myItems.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'item';
    empty.innerText = 'ç©ºç©ºå¦‚ä¹Ÿ';
    bagBox.appendChild(empty);
    return;
  }
  
  myItems.forEach(name => {
    const d = document.createElement('div');
    d.className = 'item';
    d.innerText = name;
    bagBox.appendChild(d);
  });
}

// ============== 4. æ‰“æ€ªåŠŸèƒ½ï¼ˆä¿®å¤ä¸ä¿å­˜é—®é¢˜ï¼‰ ==============
async function fight() {
  const me = getMe();
  if(!me) return print('âŒ å…ˆåˆ›å»ºé’±åŒ…');
  
  const state = await readChain();
  const items = ['é“å‰‘','å¸ƒè¡£','æˆ’æŒ‡','é´å­','è¯æ°´'];
  const name = items[Math.random()*5|0];
  
  state[me] = state[me] || [];
  state[me].push(name);
  
  // å…³é”®ï¼šä¿å­˜åˆ°é“¾
  await writeChain(state);
  
  print('ğŸ è·å¾—ï¼š'+name);
  refreshBag();
}

// ============== 5. å‘é€é“å…·ï¼ˆä¿®å¤ä¸ä¿å­˜é—®é¢˜ï¼‰ ==============
async function sendItem() {
  const me = getMe();
  const to = document.getElementById('toAddr').value.trim();
  const name = document.getElementById('itemName').value.trim();
  if(!me || !to || !name) return print('âŒ ä¿¡æ¯ä¸å…¨');

  const state = await readChain();
  if(!state[me]?.includes(name)) return print('âŒ æ— æ­¤é“å…·');

  // è½¬ç§»é“å…·
  state[me].splice(state[me].indexOf(name), 1);
  state[to] = state[to] || [];
  state[to].push(name);
  
  // å…³é”®ï¼šä¿å­˜åˆ°é“¾
  await writeChain(state);
  
  print('âœ… å‘é€æˆåŠŸï¼š'+name);
  refreshBag();
}

// åˆå§‹åŒ–ï¼šé¡µé¢åŠ è½½ç«‹å³åˆ·æ–°èƒŒåŒ…
refreshBag();
</script>
</body>
</html>
