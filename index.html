<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„é“¾æ¸¸ - é“å…·ç³»ç»Ÿ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: system-ui, sans-serif;
        }
        body {
            background: #0b0f1a;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .log {
            background: #121a29;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            min-height: 120px;
            font-size: 13px;
            white-space: pre-wrap;
        }
        .btn {
            padding: 8px 12px;
            margin:4px;
            border:none;
            border-radius:6px;
            background:#4a7dff;
            color:#fff;
            cursor:pointer;
        }
        .btn-danger {
            background: #ff4444;
        }
        .btn-success {
            background: #00C851;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>é“¾æ¸¸ - é“å…·å½’å±ç³»ç»Ÿ</h1>
    <p>çŠ¶æ€ï¼šç¬¬å››æ­¥Â·èµ„äº§ä¸Šé“¾</p>

    <div>
        <button class="btn" onclick="createWallet()">ç”Ÿæˆé’±åŒ…</button>
        <button class="btn" onclick="showMyMnemonic()">æŸ¥çœ‹åŠ©è®°è¯</button>
        <button class="btn-success" onclick="mintItem()">ç”Ÿæˆé“å…·ã€æ–°æ‰‹å‰‘ã€‘</button>
        <button class="btn" onclick="showMyItems()">æŸ¥çœ‹æˆ‘çš„é“å…·</button>
        <button class="btn" onclick="verifyChain()">æ ¡éªŒé“¾æ˜¯å¦ç¯¡æ”¹</button>
    </div>

    <h3>è°ƒè¯•æ—¥å¿—</h3>
    <div id="log" class="log">ç­‰å¾…æ“ä½œ...</div>
</div>

<script>
const logDom = document.getElementById('log');
const STORAGE_MNEMONIC = 'game_mnemonic';
const STORAGE_CHAIN = 'game_chain';

// åŠ©è®°è¯è¯åº“
const words = "apple banana cherry date elder fig grape honey ice juice kite lemon mango nut orange pear queen rose sun tomato umbrella van water xmas yellow zebra".split(" ");

// æ—¥å¿—è¾“å‡º
function log(text) {
    logDom.innerText = `[${new Date().toLocaleString()}] ${text}\n` + logDom.innerText;
}

// ====================== é’±åŒ…åŠŸèƒ½ ======================
function generateMnemonic() {
    let res = [];
    for(let i=0; i<12; i++) {
        let r = Math.floor(Math.random() * words.length);
        res.push(words[r]);
    }
    return res.join(" ");
}
function createWallet() {
    try {
        const mnemonic = generateMnemonic();
        localStorage.setItem(STORAGE_MNEMONIC, mnemonic);
        log("âœ… é’±åŒ…å·²ç”Ÿæˆ");
    } catch (e) { log("âŒ ç”Ÿæˆå¤±è´¥ï¼š"+e.message); }
}
function showMyMnemonic() {
    const mne = localStorage.getItem(STORAGE_MNEMONIC);
    mne ? log("ğŸ“„ åŠ©è®°è¯ï¼š"+mne) : log("âš ï¸ æœªåˆ›å»ºé’±åŒ…");
}

// ====================== åŸç”ŸSHA-256å“ˆå¸Œ ======================
async function sha256(str) {
    const encoder = new TextEncoder();
    const data = encoder.encode(str);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
}

// ====================== å“ˆå¸Œé“¾æ ¸å¿ƒ ======================
function initChain() {
    if(!localStorage.getItem(STORAGE_CHAIN)) {
        localStorage.setItem(STORAGE_CHAIN, JSON.stringify([]));
    }
}
function getChain() {
    return JSON.parse(localStorage.getItem(STORAGE_CHAIN) || '[]');
}
function saveChain(chain) {
    localStorage.setItem(STORAGE_CHAIN, JSON.stringify(chain));
}
async function addRecord(data) {
    const chain = getChain();
    const prevHash = chain.length > 0 ? chain[chain.length-1].hash : 'genesis';

    const block = {
        index: chain.length,
        time: Date.now(),
        prevHash: prevHash,
        data: data,
        hash: ''
    };

    block.hash = await sha256(JSON.stringify(block));
    chain.push(block);
    saveChain(chain);
    return block;
}
async function verifyChain() {
    const chain = getChain();
    if(chain.length === 0) return true;

    for(let i=1; i<chain.length; i++) {
        const cur = chain[i];
        const prev = chain[i-1];
        const temp = {...cur, hash: ''};
        const reHash = await sha256(JSON.stringify(temp));

        if(cur.hash !== reHash || cur.prevHash !== prev.hash) {
            log(`âŒ ç¬¬${i}å—è¢«ç¯¡æ”¹ï¼`);
            return false;
        }
    }
    log("âœ… å“ˆå¸Œé“¾å®Œæ•´ï¼Œèµ„äº§å®‰å…¨");
    return true;
}

// ====================== é“å…·ç³»ç»Ÿï¼ˆæ ¸å¿ƒï¼‰ ======================
// ç”Ÿæˆé“å…·ï¼Œå½’å±å½“å‰é’±åŒ…
async function mintItem() {
    const mnemonic = localStorage.getItem(STORAGE_MNEMONIC);
    if(!mnemonic) {
        log("âš ï¸ è¯·å…ˆç”Ÿæˆé’±åŒ…");
        return;
    }

    const block = await addRecord({
        type: "item",
        owner: mnemonic, // ç»‘å®šæ‰€æœ‰è€…
        itemName: "æ–°æ‰‹å‰‘",
        itemId: "item_"+Date.now() // å”¯ä¸€é“å…·ID
    });

    log(`âœ… è·å¾—ã€æ–°æ‰‹å‰‘ã€‘ï¼Œè®°å½• #${block.index}`);
}

// æŸ¥çœ‹å½“å‰é’±åŒ…çš„æ‰€æœ‰é“å…·
function showMyItems() {
    const mnemonic = localStorage.getItem(STORAGE_MNEMONIC);
    if(!mnemonic) {
        log("âš ï¸ è¯·å…ˆç”Ÿæˆé’±åŒ…");
        return;
    }

    const chain = getChain();
    const myItems = chain.filter(b => b.data.type === "item" && b.data.owner === mnemonic);

    if(myItems.length === 0) {
        log("ğŸ’ èƒŒåŒ…ä¸ºç©ºï¼Œå¿«å»ç”Ÿæˆé“å…·");
        return;
    }

    log(`ğŸ’ å…±æ‹¥æœ‰ ${myItems.length} ä¸ªé“å…·ï¼š`);
    myItems.forEach(item => {
        log(`- ${item.data.itemName} (ID:${item.data.itemId.slice(-6)})`);
    });
}

// åˆå§‹åŒ–
window.onload = () => {
    initChain();
    log("æ¸¸æˆåŸºåº§+é“å…·ç³»ç»ŸåŠ è½½å®Œæˆ âœ…");
};
</script>
</body>
</html>
