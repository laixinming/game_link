<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„é“¾æ¸¸ - è·¨è®¾å¤‡èµ„äº§æ¢å¤</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: system-ui, sans-serif;
        }
        body {
            background: #0b0f1a;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .log {
            background: #121a29;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            min-height: 120px;
            font-size: 13px;
            white-space: pre-wrap;
        }
        .btn {
            padding: 8px 12px;
            margin:4px;
            border:none;
            border-radius:6px;
            background:#4a7dff;
            color:#fff;
            cursor:pointer;
        }
        .btn-success {
            background: #00C851;
        }
        input {
            width:100%;
            padding:10px;
            margin:8px 0;
            border-radius:6px;
            border:none;
            background:#1e2530;
            color:#fff;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>é“¾æ¸¸ - è·¨è®¾å¤‡èµ„äº§æ¢å¤</h1>
    <p>çŠ¶æ€ï¼šç¬¬äº”æ­¥Â·è´¦å·&èµ„äº§åŒæ­¥</p>

    <button class="btn" onclick="createWallet()">ç”Ÿæˆæ–°é’±åŒ…</button>
    <button class="btn" onclick="showMyMnemonic()">æŸ¥çœ‹åŠ©è®°è¯</button>
    <button class="btn-success" onclick="mintItem()">ç”Ÿæˆé“å…·ã€æ–°æ‰‹å‰‘ã€‘</button>
    <button class="btn" onclick="showMyItems()">æŸ¥çœ‹æˆ‘çš„é“å…·</button>
    <button class="btn" onclick="verifyChain()">æ ¡éªŒèµ„äº§å®‰å…¨</button>

    <input id="inputMnemonic" placeholder="ç²˜è´´åŠ©è®°è¯ï¼Œè·¨è®¾å¤‡æ¢å¤è´¦å·+èµ„äº§">
    <button class="btn" onclick="restoreWalletAndAssets()">æ¢å¤è´¦å·&èµ„äº§</button>

    <h3>è°ƒè¯•æ—¥å¿—</h3>
    <div id="log" class="log">ç­‰å¾…æ“ä½œ...</div>
</div>

<script>
const logDom = document.getElementById('log');
const STORAGE_MNEMONIC = 'game_mnemonic';
const STORAGE_CHAIN = 'game_chain';

const words = "apple banana cherry date elder fig grape honey ice juice kite lemon mango nut orange pear queen rose sun tomato umbrella van water xmas yellow zebra".split(" ");

function log(text) {
    logDom.innerText = `[${new Date().toLocaleString()}] ${text}\n` + logDom.innerText;
}

// ====================== é’±åŒ… ======================
function generateMnemonic() {
    let res = [];
    for(let i=0; i<12; i++) {
        let r = Math.floor(Math.random() * words.length);
        res.push(words[r]);
    }
    return res.join(" ");
}
function createWallet() {
    try {
        const mnemonic = generateMnemonic();
        localStorage.setItem(STORAGE_MNEMONIC, mnemonic);
        log("âœ… æ–°é’±åŒ…å·²ç”Ÿæˆ");
    } catch (e) { log("âŒ ç”Ÿæˆå¤±è´¥ï¼š"+e.message); }
}
function showMyMnemonic() {
    const mne = localStorage.getItem(STORAGE_MNEMONIC);
    mne ? log("ğŸ“„ åŠ©è®°è¯ï¼š"+mne) : log("âš ï¸ æœªåˆ›å»ºé’±åŒ…");
}

// ====================== SHA256 ======================
async function sha256(str) {
    const encoder = new TextEncoder();
    const data = encoder.encode(str);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// ====================== å“ˆå¸Œé“¾ ======================
function initChain() {
    if(!localStorage.getItem(STORAGE_CHAIN)) localStorage.setItem(STORAGE_CHAIN, JSON.stringify([]));
}
function getChain() { return JSON.parse(localStorage.getItem(STORAGE_CHAIN)||'[]'); }
function saveChain(chain) { localStorage.setItem(STORAGE_CHAIN, JSON.stringify(chain)); }

async function addRecord(data) {
    const chain = getChain();
    const prevHash = chain.length?chain[chain.length-1].hash:'genesis';
    const block = {index:chain.length, time:Date.now(), prevHash, data, hash:''};
    block.hash = await sha256(JSON.stringify(block));
    chain.push(block);
    saveChain(chain);
    return block;
}

async function verifyChain() {
    const chain = getChain();
    for(let i=1;i<chain.length;i++){
        const c=chain[i],p=chain[i-1];
        const h=await sha256(JSON.stringify({...c,hash:''}));
        if(c.hash!==h||c.prevHash!==p.hash){log(`âŒ ç¬¬${i}å—è¢«ç¯¡æ”¹`);return false;}
    }
    log("âœ… å“ˆå¸Œé“¾å®Œæ•´ï¼Œèµ„äº§å®‰å…¨");
    return true;
}

// ====================== é“å…·ç³»ç»Ÿ ======================
async function mintItem() {
    const mne = localStorage.getItem(STORAGE_MNEMONIC);
    if(!mne) return log("âš ï¸ è¯·å…ˆç”Ÿæˆé’±åŒ…");
    const b = await addRecord({type:"item",owner:mne,itemName:"æ–°æ‰‹å‰‘",itemId:"item_"+Date.now()});
    log(`âœ… è·å¾—ã€æ–°æ‰‹å‰‘ã€‘ è®°å½•#${b.index}`);
}

function showMyItems() {
    const mne = localStorage.getItem(STORAGE_MNEMONIC);
    if(!mne) return log("âš ï¸ è¯·å…ˆç”Ÿæˆé’±åŒ…");
    const items = getChain().filter(b=>b.data.type==="item"&&b.data.owner===mne);
    items.length?log(`ğŸ’ å…±æœ‰${items.length}ä»¶é“å…·`)+items.forEach(i=>log(`- ${i.data.itemName}`)):log("ğŸ’ èƒŒåŒ…ç©º");
}

// ====================== è·¨è®¾å¤‡æ¢å¤ï¼ˆæœ¬æ­¥æ ¸å¿ƒï¼‰ ======================
function restoreWalletAndAssets() {
    const val = document.getElementById('inputMnemonic').value.trim();
    if(!val || val.split(/\s+/).length!==12) return log("âŒ è¯·è¾“å…¥12ä¸ªå•è¯åŠ©è®°è¯");
    localStorage.setItem(STORAGE_MNEMONIC, val);
    log("âœ… è´¦å·æ¢å¤æˆåŠŸï¼");
    log("ğŸ” æ­£åœ¨è¯»å–é“¾ä¸Šå±äºä½ çš„èµ„äº§...");
    showMyItems();
}

// ====================== åˆå§‹åŒ– ======================
window.onload = () => { initChain(); log("æ¸¸æˆåŠ è½½å®Œæˆ âœ…"); };
</script>
</body>
</html>
